name: Android-x86 RDP/NoVNC + Serveo

on:
  workflow_dispatch:
    inputs:
      iso_url:
        description: "Android-x86 ISO URL"
        required: true
      ram_mb:
        description: "RAM for Android VM (MB)"
        required: false
        default: 2048
      runtime_minutes:
        description: "Runtime in minutes"
        required: false
        default: 355

jobs:
  android-novnc:
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y qemu-system-x86 novnc websockify wget openssh-client

      - name: Download Android-x86 ISO
        run: |
          wget -O android.iso "${{ inputs.iso_url }}"

      - name: Create disk image
        run: |
          qemu-img create -f qcow2 android_disk.qcow2 8G

      - name: Launch Android-x86 headless + VNC
        run: |
          # Start Android VM headless on VNC :1
          qemu-system-x86_64 \
            -m "${{ inputs.ram_mb }}" \
            -hda android_disk.qcow2 \
            -cdrom android.iso \
            -boot d \
            -net nic -net user \
            -vnc :1 \
            -no-reboot \
            -enable-kvm \
            -cpu host \
            -display none &
          sleep 5

          # Start websockify for noVNC access
          websockify 6080 localhost:5901 &
          sleep 2

      - name: Open Serveo reverse tunnel & print public URL
        run: |
          # Serveo reverse tunnel
          URL=$(ssh -o StrictHostKeyChecking=no -R 0:localhost:6080 serveo.net 2>&1 | grep -oE 'https://[a-z0-9.-]+\.serveo.net')
          echo "noVNC public URL: $URL"

      - name: Keep VM alive
        run: |
          RUNTIME=${{ inputs.runtime_minutes }}
          END=$((SECONDS + RUNTIME * 60))
          while [ $SECONDS -lt $END ]; do
            echo "[Android-x86] Heartbeat $(date) | Runtime ends in $(( ($END - $SECONDS)/60 )) min"
            sleep 60
          done
