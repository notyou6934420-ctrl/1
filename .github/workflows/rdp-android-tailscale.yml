name: Android-x86 RDP + NoVNC + Cloudflare Tunnel

on:
  workflow_dispatch:
    inputs:
      android_iso_url:
        description: "Android-x86 ISO URL (curl/wget compatible)"
        required: true
      runtime_minutes:
        description: "Runtime in minutes (default 355)"
        required: false
        default: 355

jobs:
  android_novnc:
    runs-on: ubuntu-latest
    timeout-minutes: 370
    env:
      DISPLAY: :1
      VNC_PASS: android123
    steps:
    - name: Install dependencies
      run: |
        sudo apt update && sudo apt install -y qemu-system-x86 x11vnc xvfb novnc wget curl
        curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
        chmod +x cloudflared
        sudo mv cloudflared /usr/local/bin/

    - name: Download Android-x86 ISO
      run: |
        wget -O android.iso "${{ inputs.android_iso_url }}"

    - name: Start virtual display
      run: |
        Xvfb :1 -screen 0 1024x768x16 &
        sleep 2

    - name: Start Android-x86 in QEMU
      run: |
        qemu-system-x86_64 \
          -m 2048 \
          -boot d \
          -cdrom android.iso \
          -vnc :1,password \
          -k en-us \
          -monitor none \
          -no-reboot &
        sleep 10

    - name: Set VNC password
      run: |
        echo $VNC_PASS | x11vnc -storepasswd -f ~/.vnc/passwd

    - name: Start x11vnc
      run: |
        x11vnc -forever -usepw -display :1 -rfbport 5900 &
        sleep 5

    - name: Expose VNC via Cloudflare Tunnel
      run: |
        cloudflared tunnel --url tcp://localhost:5900 > cf_tunnel.log 2>&1 &
        sleep 10
        # Print public URL
        grep "tcp://.*trycloudflare.com" cf_tunnel.log || echo "Tunnel URL not found yet"

    - name: Keep alive
      run: |
        END=$((SECONDS+${{ inputs.runtime_minutes }}*60))
        while [ $SECONDS -lt $END ]; do
          echo "Android-x86 NoVNC alive: $(date)"
          sleep 60
        done
